<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WHM 462 集签地图 · V3.1（蓝底·五级蓝）</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  html,body,#map{height:100%;margin:0;background:#0b1d3d;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"PingFang SC","Microsoft YaHei",sans-serif}
  .legend{position:absolute;left:12px;bottom:12px;background:#fff;color:#000;padding:10px 12px;border-radius:8px;box-shadow:0 1px 6px rgba(0,0,0,.2);font-size:12px;line-height:1.5}
  .legend .row{display:flex;align-items:center;margin:3px 0}
  .sw{width:16px;height:16px;border-radius:3px;margin-right:8px;border:1px solid #9db3ff99}
  .panel{position:absolute;right:12px;top:12px;max-width:420px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 8px rgba(0,0,0,.25);display:none}
  .panel h3{margin:0 0 6px;font-size:16px}
  .job{border-top:1px solid #eee;padding:8px 0}
  .job a{color:#0b5fff;text-decoration:none}
  .job small{display:block;color:#666}
  .pill{display:inline-block;background:#eef;border-radius:999px;padding:2px 8px;margin:2px 4px 0 0;font-size:12px}
  .note{font-size:12px;color:#444;margin-top:6px}
  .badge{position:absolute;left:12px;top:12px;background:#fff;color:#222;padding:8px 10px;border-radius:8px;box-shadow:0 1px 6px rgba(0,0,0,.18);font-size:12px}
</style>
</head>
<body>
<div id="map"></div>

<div class="badge" id="badge">状态：加载中…（已内置 462 规则，先行着色）</div>

<div class="legend">
  <div style="font-weight:700;margin-bottom:6px;color:#000">可集签岗位（近10天）· 五级蓝色</div>
  <div class="row"><span class="sw" style="background:#eaf2ff"></span>0</div>
  <div class="row"><span class="sw" style="background:#cfe1ff"></span>1–5</div>
  <div class="row"><span class="sw" style="background:#9fc2ff"></span>6–20</div>
  <div class="row"><span class="sw" style="background:#5b94ff"></span>21–50</div>
  <div class="row"><span class="sw" style="background:#1e6bff"></span>51+</div>
  <div style="margin:6px 0;border-top:1px dashed #ccc"></div>
  <div class="row"><span class="sw" style="background:#e4e6eb;border:1px dashed #ff4d4f"></span><span style="color:#c0392b">不可集签（462）</span></div>
  <div class="note">底图为纯蓝背景；边界为 ABS POA（邮政区近似）。</div>
</div>

<div class="panel" id="jobsPanel">
  <h3 id="jobsTitle"></h3>
  <div id="jobsSub"></div>
  <div id="jobsList"></div>
  <div class="note">岗位来源：Workforce Australia（官方）。仅统计近10天，并按 462 行业口径筛选。</div>
</div>

<script>
// ====== 数据源（POA 多边形）======
const POA_GEOJSON_URL='https://cdn.jsdelivr.net/gh/ferocia/australia-geojsons@master/outputs/au-postcodes-Visvalingam-5.geojson';

// ====== 五级蓝色 & 不可集签样式 ======
const blue5=n=> n<=0 ? '#eaf2ff' : n<=5 ? '#cfe1ff' : n<=20 ? '#9fc2ff' : n<=50 ? '#5b94ff' : '#1e6bff';
const STYLE_INELIG={fillColor:'#e4e6eb',color:'#ff4d4f',weight:1.2,dashArray:'6,4',fillOpacity:.35,opacity:.95};

// ====== 内置 462 规则（兜底，保证先分“蓝/灰”）======
const RULES = {
  tourismExtraPostcodes: ["4406","4416","4498","7215"],
  northern: {
    ntAll: true,
    postcodes: [
      // WA（北澳）
      "0872","6537","6642","6646","6701","6705","6707","6710","6711","6712","6713","6714","6716","6718",
      "6720","6721","6722","6725","6726","6728","6740","6743","6751","6753","6754","6758","6760","6762","6765","6770",
      // QLD（北澳，含 47xx/48xx/49xx 大量段）
      "4472","4478","4481","4482","4680","4694","4695","4697","4699",
      "4700","4701","4702","4703","4704","4705","4706","4707","4709","4710","4711","4712","4713","4714","4717",
      "4720","4721","4722","4723","4724","4725","4726","4727","4728",
      "4730","4731","4732","4733","4735","4736","4737","4738","4739",
      "4740","4741","4742","4743","4744","4745","4746",
      "4750","4751","4753","4754","4756","4757",
      "4798","4799",
      "4800","4801","4802","4803","4804","4805","4806","4807","4808","4809",
      "4810","4811","4812","4814","4815","4816","4817","4818","4819",
      "4820","4821","4822","4823","4824","4825","4828","4829","4830",
      "4849","4850","4852","4854","4855","4856","4858","4859",
      "4860","4861","4865","4868","4869",
      "4870","4871","4872","4873","4874","4875","4876","4877","4878","4879",
      "4880","4881","4882","4883","4884","4885","4886","4887","4888",
      "4890","4891","4892","4895"
    ]
  },
  regionalByState:{
    NSW:["2311-2312","2328-2411","2420-2490","2536-2551","2575-2594","2618-2739","2787-2898"],
    VIC:["3139","3211-3334","3340-3424","3430-3649","3658-3749","3753","3756","3758","3762","3764","3778-3781","3783","3797","3799","3810-3909","3921-3925","3945-3974","3979","3981-3996"],
    QLD:["4124-4125","4133","4211","4270-4272","4275","4280","4285","4287","4307-4499","4510","4512","4515-4519","4522-4899"],
    WA:["6041-6044","6055-6056","6069","6076","6083-6084","6111","6121-6126","6200-6799"],
    SA:["ALL"],TAS:["ALL"],NT:["ALL"],NORFOLK:["ALL"]
  },
  remoteVRByState:{
    NSW:["2356","2386-2387","2396","2405-2406","2672","2675","2717","2721","2726","2734-2735","2737-2739","2831","2836","2839-2842","2879","2898"],
    QLD:["4472","4478","4481-4482","4694-4695","4697","4699-4707","4709-4714","4717","4720-4728","4730-4733","4735-4746","4750-4751","4753-4754","4756-4757","4798-4812","4814-4825","4828-4830","4849-4861","4865","4868-4888","4890-4892","4895"],
    SA:["5220-5223","5302-5304","5440","5576-5577","5582-5583","5602-5607","5611","5630-5633","5640-5642","5650-5654","5658","5660-5661","5670","5680","5690"],
    WA:["0872","6434","6442-6450","6468","6473-6479","6485-6490","6510","6513-6515","6517","6535-6537","6558-6562","6605-6606","6609-6611","6613","6615-6616","6620-6623","6625-6630","6635-6642","6646-6647","6701","6705","6707","6710-6714","6716","6718","6720-6722","6725-6726","6728","6740","6743","6751","6753-6754","6758","6760","6762","6765","6770"],
    NT:["ALL"],TAS:[],VIC:[],ACT:[]
  }
};

// ====== 岗位数据（占位；若仓库里有 data/jobs-last10d.json 会覆盖）======
let JOBS = { perPOA:{} };

// ====== 工具：取 POA 代码（尽量兼容各种属性名）======
function getPOA(props){
  // 先按常见字段
  const preferred=['POA_CODE21','poa_code_2021','postcode','POA_CODE','code','id','name'];
  for(const k of preferred){
    if(props[k]){ const m=String(props[k]).match(/(^|[^0-9])(0?\d{3,4})([^0-9]|$)/); if(m) return m[2].padStart(4,'0'); }
  }
  // 兜底：在所有值里找 4 位数字
  for (const v of Object.values(props)){
    const m=String(v).match(/(^|[^0-9])(0?\d{3,4})([^0-9]|$)/);
    if(m) return m[2].padStart(4,'0');
  }
  return null;
}
function getPOAName(props){ return props.POA_NAME21||props.poa_name_2021||props.name||('POA '+getPOA(props)); }

// ====== 判断：邮编属于哪个范围 ======
function stateByPc(pc){
  pc=String(pc).padStart(4,'0'); const p=pc[0];
  if(p==='2') return 'NSW';
  if(p==='3') return 'VIC';
  if(p==='4') return 'QLD';
  if(p==='5') return 'SA';
  if(p==='6') return 'WA';
  if(p==='7') return 'TAS';
  if(p==='0'||p==='8'||p==='9') return 'NT';
  return 'Other';
}
function inRanges(ranges, pc){
  pc=String(pc).padStart(4,'0');
  return (ranges||[]).some(s=>{
    s=String(s).trim();
    if(s==='ALL') return true;
    if(s.includes('-')){ const[a,b]=s.split('-').map(x=>parseInt(x,10)); const n=parseInt(pc,10); return n>=a&&n<=b; }
    return pc===s.padStart(4,'0');
  });
}
function inRegional(pc){
  const st=stateByPc(pc); const segs=(RULES.regionalByState[st]||[]);
  if(segs.includes('ALL')) return true;
  return inRanges(segs, pc);
}
function inRemoteVR(pc){
  const st=stateByPc(pc); const segs=(RULES.remoteVRByState[st]||[]);
  if(segs.includes('ALL')) return true;
  if(inRanges(segs, pc)) return true;
  return (RULES.tourismExtraPostcodes||[]).includes(String(pc).padStart(4,'0'));
}
function inNorthern(pc){
  const s=stateByPc(pc);
  if(s==='NT' && RULES.northern.ntAll) return true;
  return (RULES.northern.postcodes||[]).includes(String(pc).padStart(4,'0'));
}
function industriesFor462(pc){
  const inds=[];
  if (inNorthern(pc) || inRemoteVR(pc)) inds.push('Tourism & Hospitality');
  if (inNorthern(pc) || inRegional(pc)) { inds.push('Plant & Animal cultivation'); inds.push('Construction'); }
  if (inNorthern(pc)) inds.push('Fishing & Pearling / Tree farming & felling');
  return inds;
}

// ====== 加载仓库里的数据（若没有，保持占位）======
async function loadExternal(){
  try{
    const r = await fetch('data/jobs-last10d.json',{cache:'no-store'});
    if (r.ok){ JOBS = await r.json(); }
  }catch{}
}

// ====== 地图渲染 ======
async function init(){
  await loadExternal();
  const map=L.map('map',{preferCanvas:true,zoomControl:true}).setView([-25.3,133.8],4);

  // 不加载底图瓦片，保持纯蓝背景

  const resp=await fetch(POA_GEOJSON_URL);
  const geo=await resp.json();

  const layer=L.geoJSON(geo,{
    style:f=>{
      const pc=getPOA(f.properties); const inds=industriesFor462(pc);
      if(!inds.length) return STYLE_INELIG;
      const n=(JOBS?.perPOA?.[pc]?.count)||0;
      return { fillColor:blue5(n), color:'#193a7a', weight:.6, fillOpacity:.72, opacity:.95 };
    },
    onEachFeature:(f,poly)=>{
      const pc=getPOA(f.properties); const nm=getPOAName(f.properties);
      const inds=industriesFor462(pc);

      poly.on('mouseover', e=>{
        const n=(JOBS?.perPOA?.[pc]?.count)||0;
        const html=`
          <div style="font-weight:700;margin-bottom:4px;">${nm}（POA ${pc}）</div>
          <div>${inds.length? '可集签行业：'+inds.map(i=>`<span class="pill">${i}</span>`).join(' ') : '<span style="color:#c0392b">不可集签（462）</span>'}</div>
          <div style="margin-top:6px;">近10天岗位总数：<b>${n}</b></div>`;
        poly.bindTooltip(html,{sticky:true,opacity:.97,direction:'top',offset:[0,-6]}).openTooltip(e.latlng);
        poly.setStyle({weight:1.2,fillOpacity:.85});
      });
      poly.on('mouseout', ()=> poly.setStyle({weight:.6,fillOpacity:.72}));

      poly.on('click', ()=>{
        const panel=document.getElementById('jobsPanel');
        const title=document.getElementById('jobsTitle');
        const sub=document.getElementById('jobsSub');
        const list=document.getElementById('jobsList');

        const n=(JOBS?.perPOA?.[pc]?.count)||0;
        const items=(JOBS?.perPOA?.[pc]?.items)||[];

        title.textContent = `${nm}（POA ${pc}）`;
        sub.innerHTML = `${inds.length? '可集签行业：'+inds.map(i=>`<span class="pill">${i}</span>`).join(' ') : '<span style="color:#c0392b">不可集签（462）</span>'} · 近10天岗位：<b>${n}</b>`;

        list.innerHTML='';
        if (!items.length) {
          const wf = `https://www.workforceaustralia.gov.au/individuals/jobs/search?searchText=${encodeURIComponent(pc)}`;
          list.innerHTML = `<div class="note">暂未抓到岗位清单（或尚未更新）。<br/>你可以先在官方站查看：<a href="${wf}" target="_blank" rel="noopener">Workforce Australia（搜索 ${pc}）</a></div>`;
        } else {
          items.slice(0,80).forEach(it=>{
            const div=document.createElement('div'); div.className='job';
            div.innerHTML = `<a href="${it.url}" target="_blank" rel="noopener">${it.title||'职位'}</a>
                             <small>${(it.company||'').trim()} ${it.location? '· '+it.location:''} ${it.age||''}</small>`;
            list.appendChild(div);
          });
        }
        panel.style.display='block';
        poly.bringToFront();
      });
    }
  }).addTo(map);

  const b=document.getElementById('badge');
  if(b){ b.innerHTML='状态：<b>就绪</b> · 规则内置 · 岗位数据 '+(JOBS && JOBS.perPOA && Object.keys(JOBS.perPOA).length?'已加载':'占位'); }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
